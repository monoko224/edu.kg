<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>慶桜大学学生証生成サービス</title>
    <script src="https://html2canvas.hertzen.com/dist/html2canvas.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsbarcode@3.11.5/dist/JsBarcode.all.min.js"></script>
    <style>
        * {
            box-sizing: border-box;
        }
        
        body {
            font-family: "MS Gothic", "Yu Gothic", "Hiragino Sans", sans-serif;
            background: linear-gradient(135deg, #f5f5f5 0%, #e0e0e0 100%);
            margin: 0;
            padding: 20px;
            color: #333;
            display: flex;
            flex-direction: column;
            align-items: center;
            min-height: 100vh;
            justify-content: center;
        }
        
        .header {
            text-align: center;
            margin-bottom: 25px;
            width: 100%;
            max-width: 1200px;
        }
        
        h1 {
            color: #800020;
            margin-bottom: 10px;
            font-size: 28px;
            text-shadow: 1px 1px 2px rgba(0,0,0,0.1);
        }
        
        .description {
            color: #666;
            max-width: 800px;
            margin: 0 auto 20px;
            line-height: 1.6;
        }
        
        .container {
            display: flex;
            flex-wrap: wrap;
            gap: 30px;
            max-width: 1200px;
            margin: 0 auto;
            justify-content: center;
            width: 100%;
        }
        
        .form-container {
            background: white;
            padding: 25px;
            border-radius: 12px;
            box-shadow: 0 5px 20px rgba(0, 0, 0, 0.15);
            width: 350px;
            height: fit-content;
            max-width: 100%;
        }
        
        .preview-container {
            position: relative;
            margin-top: 20px;
            display: flex;
            justify-content: center;
        }
        
        .language-switcher {
            text-align: right;
            margin-bottom: 20px;
            display: flex;
            justify-content: flex-end;
            gap: 10px;
            width: 100%;
            max-width: 1200px;
        }
        
        .language-switcher button {
            background: none;
            border: 2px solid #800020;
            color: #800020;
            padding: 8px 15px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
        }
        
        .language-switcher button.active {
            background: #800020;
            color: white;
        }
        
        .language-switcher button:hover {
            transform: translateY(-2px);
            box-shadow: 0 3px 8px rgba(0,0,0,0.1);
        }
        
        .form-group {
            margin-bottom: 18px;
        }
        
        label {
            display: block;
            margin-bottom: 8px;
            font-weight: bold;
            color: #555;
            font-size: 14px;
        }
        
        input, select {
            width: 100%;
            padding: 10px;
            border: 1px solid #ddd;
            border-radius: 6px;
            box-sizing: border-box;
            font-family: inherit;
            transition: border 0.3s;
        }
        
        input:focus, select:focus {
            border-color: #800020;
            outline: none;
            box-shadow: 0 0 0 2px rgba(128, 0, 32, 0.2);
        }
        
        .action-buttons {
            display: flex;
            gap: 12px;
            margin-top: 25px;
        }
        
        button {
            padding: 12px 18px;
            border: none;
            border-radius: 6px;
            cursor: pointer;
            font-weight: bold;
            transition: all 0.3s;
            font-family: inherit;
        }
        
        .btn-update {
            background-color: #800020;
            color: white;
            flex: 1;
        }
        
        .btn-update:hover {
            background-color: #600018;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .btn-download {
            background-color: #2c3e50;
            color: white;
            flex: 1;
        }
        
        .btn-download:hover {
            background-color: #1a252f;
            transform: translateY(-2px);
            box-shadow: 0 4px 8px rgba(0,0,0,0.2);
        }
        
        .download-info {
            text-align: center;
            margin-top: 15px;
            color: #666;
            font-size: 14px;
            max-width: 350px;
        }
        
        /* 学生証样式 - 与原文件保持一致 */
        .student-id::before {
            content: "";
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 400px;
            height: 400px;
            background-image: url("data:image/svg+xml;charset=utf-8;base64,PD94bWwgdmVyc2lvbj0iMS4wIiBlbmNvZGluZz0iVVRGLTgiIHN0YW5kYWxvbmU9Im5vIj8ks1Q1lJST0iIC8+Cjwvc3ZnPgo=");
            background-repeat: no-repeat;
            background-position: center;
            opacity: 0.12;
            z-index: 0;
            pointer-events: none;
            margin-top: 25px;
        }

        .student-id {
            width: 350px;
            height: 220px;
            background: linear-gradient(135deg, #c2b1b1f3 0%, #f7f3f3 100%);
            border-radius: 10px;
            box-shadow: 0 4px 15px rgba(0, 0, 0, 0.2);
            padding: 20px;
            position: relative;
            overflow: hidden;
            border: 1px solid #d0d0d0;
            max-width: 100%;
        }
        
        .header-band {
            position: absolute;
            top: 0;
            left: 0;
            width: 100%;
            height: 20px;
            background-color: #800020;
            display: flex;
            justify-content: flex-end;
            align-items: center;
            padding-right: 20px;
            box-sizing: border-box;
        }
        
        .header-band-text {
            color: white;
            font-size: 14px;
            font-weight: bold;
            letter-spacing: 1px;
        }
        
        .university-header {
            display: flex;
            align-items: center;
            border-bottom: 2px solid #800020;
            padding-bottom: 8px;
            margin-bottom: 15px;
            margin-top: 6px;
        }
        
        .university-logo {
            width: 40px;
            height: 40px;
            margin-right: 10px;
            display: flex;
            justify-content: center;
            align-items: center;
        }
        
        .university-name {
            font-size: 16px;
            font-weight: bold;
            color: #800020;
        }
        
        .student-id-text {
            position: absolute;
            left: 70%;
            transform: translateX(-50%);
            font-size: 16px;
            font-weight: bold;
            color: #800020;
            margin-top: 12px;
        }

        .english-text {
            display: block;
            font-size: 10px;
            font-weight: normal;
            color: #800020;
            letter-spacing: 0.5px;
            margin-top: 2px;
            text-align: center;
        }
        
        .id-content {
            display: flex;
        }
        
        .photo-section {
            width: 80px;
            margin-right: 15px;
        }
        
        .student-photo {
            width: 75px;
            height: 95px;
            background-color: #f0f0f0;
            border: 1px solid #d0d0d0;
            display: flex;
            justify-content: center;
            align-items: center;
            font-size: 10px;
            color: #888;
            margin-bottom: 5px;
            position: relative;
            overflow: hidden;
        }
        
        .barcode-container {
            width: 75px;
            height: 30px;
            display: flex;
            justify-content: center;
            align-items: center;
            background: rgba(255, 255, 255, 0);
            overflow: hidden;
        }
        
        .info-section {
            flex-grow: 1;
        }
        
        .info-row {
            display: flex;
            margin-bottom: 6px;
            font-size: 12px;
        }
        
        .info-label {
            width: 70px;
            color: #302c2c;
            font-weight: bold;
        }
        
        .info-value {
            flex-grow: 1;
            font-weight: normal;
        }
        
        .valid-date {
            font-size: 11px;
            text-align: right;
            margin-top: 10px;
            color: #666;
        }
        
        /* 增强的防伪标签 */
        .hologram {
            position: absolute;
            top: 25px;
            right: 20px;
            width: 40px;
            height: 40px;
            border-radius: 10%;
            opacity: 0.7;
            background: url('data:image/svg+xml;charset=utf-8;base64,iIGZpbGw9IiNjMGI5MmQiPjwvcGF0aD48L3N2Zz4=');
            background-size: cover;
        }
        
        .hologram::before {
            content: "";
            position: absolute;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: 
                repeating-linear-gradient(
                    45deg,
                    transparent,
                    transparent 5px,
                    rgba(255,255,255,0.2) 5px,
                    rgba(255,255,255,0.2) 10px
                );
        }
        
        .watermark {
            position: absolute;
            bottom: 30px;
            right: 15px;
            font-size: 40px;
            font-weight: bold;
            opacity: 0.1;
            color: #800020;
            transform: rotate(0deg);
            pointer-events: none;
        }
        
        .university-address {
            font-size: 8px;
            text-align: center;
            margin-top: 6px;
            color: #666;
        }
        
        .student-id-number {
            font-size: 14px;
            font-weight: bold;
            color: #800020;
            text-align: right;
            margin-bottom: 5px;
        }
        
        /* 添加加载动画 */
        .loading {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(255, 255, 255, 0.8);
            z-index: 9999;
            justify-content: center;
            align-items: center;
            flex-direction: column;
        }
        
        .spinner {
            width: 50px;
            height: 50px;
            border: 5px solid #f3f3f3;
            border-top: 5px solid #800020;
            border-radius: 50%;
            animation: spin 1s linear infinite;
            margin-bottom: 15px;
        }
        
        @keyframes spin {
            0% { transform: rotate(0deg); }
            100% { transform: rotate(360deg); }
        }
        
        /* 响应式设计 */
        @media (max-width: 900px) {
            body {
                padding: 15px;
                justify-content: flex-start;
            }
            
            .container {
                flex-direction: column;
                align-items: center;
                gap: 20px;
            }
            
            .form-container, .preview-container {
                width: 100%;
                max-width: 400px;
            }
            
            .header {
                margin-bottom: 15px;
            }
            
            h1 {
                font-size: 24px;
            }
            
            .description {
                font-size: 14px;
            }
            
            .language-switcher {
                justify-content: center;
                margin-bottom: 15px;
            }
        }
        
        @media (max-width: 480px) {
            body {
                padding: 10px;
            }
            
            .form-container {
                padding: 15px;
            }
            
            .student-id {
                transform: scale(0.9);
                transform-origin: top center;
            }
            
            h1 {
                font-size: 20px;
            }
        }
    </style>
</head>
<body>
    <div class="header">
        <h1 id="title">慶桜大学学生証生成サービス</h1>
        <p class="description" id="description">フォームに入力して学生証を生成し、画像としてダウンロードできます。生成された学生証は慶桜大学の正式な証明書として使用できます。</p>
    </div>
    
    <div class="language-switcher">
        <button id="lang-ja" class="active">日本語</button>
        <button id="lang-zh">中文</button>
    </div>
    
    <div class="container">
        <div class="form-container">
            <div class="form-group">
                <label for="studentNumber" id="label-studentNumber">学籍番号</label>
                <input type="text" id="studentNumber" value="88888888">
            </div>
            
            <div class="form-group">
                <label for="studentName" id="label-studentName">氏名</label>
                <input type="text" id="studentName" value="">
            </div>
            
            <div class="form-group">
                <label for="birthDate" id="label-birthDate">生年月日</label>
                <input type="date" id="birthDate" value="">
            </div>
            
            <div class="form-group">
                <label for="faculty" id="label-faculty">学部</label>
                <select id="faculty">
                    <option value="サボリ工学部">サボリ工学部</option>
                    <option value="モーフィス学部">モーフィス学部</option>
                    <option value="単位取得学部">単位取得学部</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="department" id="label-department">学科</label>
                <select id="department">
                    <option value="エレガントサボリ専攻">エレガントサボリ専攻</option>
                    <option value="モーフィス科学専攻">モーフィス科学専攻</option>
                    <option value="単位取得学専攻">単位取得学専攻</option>
                </select>
            </div>
            
            <div class="form-group">
                <label for="enrollmentDate" id="label-enrollmentDate">入学年月</label>
                <input type="month" id="enrollmentDate" value="">
            </div>
            
            <div class="form-group">
                <label for="expiryDate" id="label-expiryDate">有効期限</label>
                <input type="date" id="expiryDate" value="2027-03-31">
            </div>
            
            <div class="action-buttons">
                <button class="btn-update" id="updateBtn">学生証を更新</button>
                <button class="btn-download" id="downloadBtn">画像をダウンロード</button>
            </div>
            
            <div class="download-info" id="downloadInfo">
                高品質のPNG画像としてダウンロードされます。防伪要素と透かしが含まれています。
            </div>
        </div>
        
        <div class="preview-container">
            <div class="student-id" id="studentCard">
                <div class="header-band">
                    <div class="header-band-text">keio university</div>
                </div>
                <div class="university-header">
                    <div class="university-logo">
                        <svg version="1.1" id="Layer_1" xmlns="http://www.w3.org/2000/svg" xmlns:xlink="http://www.w3.org/1999/xlink" x="0px" y="0px" width="220px" height="220px" viewBox="0 0 220 220" enable-background="new 0 0 220 220" xml:space="preserve">  <image id="image0" width="220" height="220" x="0" y="0"
    xlink:href="data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAANwAAADcCAYAAAAbWs+BAAAAIGNIUk0AAHomAACAhAAA+gAAAIDo
0AAAAAKHRFWHRkYXRlOnRpbWVz
dGFtcAAyMDI1LTA4LTI3VDE0OjEyOjE2KzAwOjAwdo7M3wAAAABJRU5ErkJggg==" />
</svg>
                    </div>
                    <div class="university-name">慶桜大学</div>
                    <div class="student-id-text">学生証 <span class="english-text">Student ID Card</span></div>
                </div>
                
                <div class="student-id-number">学籍番号: <span id="preview-studentNumber">23145012</span></div>
                
                <div class="id-content">
                    <div class="photo-section">
                        <div class="student-photo">学生写真</div>
                        <div class="barcode-container">
                            <svg id="barcode"></svg>
                        </div>
                    </div>
                    
                    <div class="info-section">
                        <div class="info-row">
                            <div class="info-label">氏名</div>
                            <div class="info-value" id="preview-studentName">湯普春</div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">生年月日</div>
                            <div class="info-value" id="preview-birthDate">2002/07/01</div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">学部</div>
                            <div class="info-value" id="preview-faculty">サボリ工学部</div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">学科</div>
                            <div class="info-value" id="preview-department">エレガントサボリ専攻</div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">入学年月</div>
                            <div class="info-value" id="preview-enrollmentDate">2023/04</div>
                        </div>
                        
                        <div class="info-row">
                            <div class="info-label">有効期限</div>
                            <div class="info-value" id="preview-expiryDate">2027年3月31日</div>
                        </div>
                    </div>
                </div>
                
                <div class="university-address">〒150-0043 東京都渋谷区桜丘1-1-1</div>
                
                <div class="hologram"></div>
                <div class="watermark">慶桜</div>
            </div>
        </div>
    </div>
    
    <div class="loading" id="loading">
        <div class="spinner"></div>
        <div id="loadingText">画像を生成中...</div>
    </div>

    <script>
        // 语言切换功能
        document.getElementById('lang-ja').addEventListener('click', function() {
            setLanguage('ja');
            this.classList.add('active');
            document.getElementById('lang-zh').classList.remove('active');
        });
        
        document.getElementById('lang-zh').addEventListener('click', function() {
            setLanguage('zh');
            this.classList.add('active');
            document.getElementById('lang-ja').classList.remove('active');
        });
        
        function setLanguage(lang) {
            const translations = {
                'ja': {
                    'title': '慶桜大学学生証生成サービス',
                    'description': 'フォームに入力して学生証を生成し、画像としてダウンロードできます。生成された学生証は慶桜大学の正式な証明書として使用できます。',
                    'label-studentNumber': '学籍番号',
                    'label-studentName': '氏名',
                    'label-birthDate': '生年月日',
                    'label-faculty': '学部',
                    'label-department': '学科',
                    'label-enrollmentDate': '入学年月',
                    'label-expiryDate': '有効期限',
                    'updateBtn': '学生証を更新',
                    'downloadBtn': '画像をダウンロード',
                    'downloadInfo': '高品質のPNG画像としてダウンロードされます。防伪要素と透かしが含まれています。',
                    'loadingText': '画像を生成中...'
                },
                'zh': {
                    'title': '庆樱大学学生证生成服务',
                    'description': '通过表单输入生成学生证，并可以下载为图片。生成的学生证可以作为庆樱大学的正式证明文件使用。',
                    'label-studentNumber': '学籍编号',
                    'label-studentName': '姓名',
                    'label-birthDate': '出生日期',
                    'label-faculty': '学院',
                    'label-department': '专业',
                    'label-enrollmentDate': '入学时间',
                    'label-expiryDate': '有效期',
                    'updateBtn': '更新学生证',
                    'downloadBtn': '下载图片',
                    'downloadInfo': '将下载为高质量的PNG图片，包含防伪元素和水印。',
                    'loadingText': '图片生成中...'
                }
            };
            
            Object.keys(translations[lang]).forEach(key => {
                if (document.getElementById(key)) {
                    document.getElementById(key).textContent = translations[lang][key];
                }
            });
        }
        
        // 更新学生证预览
        document.getElementById('updateBtn').addEventListener('click', updateStudentCard);
        
        function updateStudentCard() {
            // 获取表单值
            const studentNumber = document.getElementById('studentNumber').value;
            const studentName = document.getElementById('studentName').value;
            const birthDate = formatDate(document.getElementById('birthDate').value);
            const faculty = document.getElementById('faculty').value;
            const department = document.getElementById('department').value;
            const enrollmentDate = formatMonth(document.getElementById('enrollmentDate').value);
            const expiryDate = formatExpiryDate(document.getElementById('expiryDate').value);
            
            // 更新预览
            document.getElementById('preview-studentNumber').textContent = studentNumber;
            document.getElementById('preview-studentName').textContent = studentName;
            document.getElementById('preview-birthDate').textContent = birthDate;
            document.getElementById('preview-faculty').textContent = faculty;
            document.getElementById('preview-department').textContent = department;
            document.getElementById('preview-enrollmentDate').textContent = enrollmentDate;
            document.getElementById('preview-expiryDate').textContent = expiryDate;
            
            // 生成条形码
            generateBarcode(studentNumber);
        }
        
        // 生成条形码函数
        function generateBarcode(studentNumber) {
            try {
                JsBarcode("#barcode", studentNumber, {
                    format: "CODE128",
                    lineColor: "#000",
                    width: 1.2,
                    height: 30,
                    displayValue: false,
                    margin: 0
                });
            } catch (error) {
                console.error("条形码生成错误:", error);
                // 如果生成失败，显示默认条形码
                document.getElementById("barcode").innerHTML = `
                    <rect width="75" height="30" fill="#fff" />
                    ${createSimpleBarcode(studentNumber)}
                `;
            }
        }
        
        // 简单条形码生成（备用方案）
        function createSimpleBarcode(studentNumber) {
            // 将学号转换为哈希值用于生成条形码模式
            let hash = 0;
            for (let i = 0; i < studentNumber.length; i++) {
                hash = studentNumber.charCodeAt(i) + ((hash << 5) - hash);
            }
            
            // 生成条形码线条
            let bars = "";
            const barCount = 30;
            const barWidth = 75 / barCount;
            
            for (let i = 0; i < barCount; i++) {
                // 使用哈希值确定条码高度
                const barHeight = 5 + (hash % 20);
                hash = (hash * 1664525 + 1013904223) % 4294967296; // 简单的伪随机数生成
                
                if (i % 2 === 0) {
                    bars += `<rect x="${i * barWidth}" y="${15 - barHeight/2}" width="${barWidth}" height="${barHeight}" fill="#000" />`;
                }
            }
            
            return bars;
        }
        
        // 日期格式化函数
        function formatDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${date.getFullYear()}/${String(date.getMonth() + 1).padStart(2, '0')}/${String(date.getDate()).padStart(2, '0')}`;
        }
        
        function formatMonth(monthString) {
            if (!monthString) return '';
            const [year, month] = monthString.split('-');
            return `${year}/${month}`;
        }
        
        function formatExpiryDate(dateString) {
            if (!dateString) return '';
            const date = new Date(dateString);
            return `${date.getFullYear()}年${date.getMonth() + 1}月${date.getDate()}日`;
        }
        
        // 下载功能 - 修复iOS兼容性问题
        document.getElementById('downloadBtn').addEventListener('click', downloadCard);
        
        function downloadCard() {
            // 显示加载指示器
            const loading = document.getElementById('loading');
            loading.style.display = 'flex';
            
            // 使用setTimeout确保UI更新
            setTimeout(() => {
                // 克隆学生证元素
                const cardElement = document.getElementById('studentCard');
                const clone = cardElement.cloneNode(true);
                
                // 移除可能干扰的元素
                clone.style.boxShadow = 'none';
                clone.style.transform = 'translateZ(0)'; // 触发GPU加速
                
                // 添加到文档中进行渲染
                clone.style.position = 'absolute';
                clone.style.left = '-9999px';
                document.body.appendChild(clone);
                
                // 使用html2canvas进行渲染
                html2canvas(clone, {
                    scale: 2, // 降低分辨率以提高iOS兼容性
                    logging: false,
                    useCORS: true,
                    backgroundColor: null,
                    onclone: function(document, element) {
                        // 确保所有样式正确应用
                        element.style.boxShadow = 'none';
                    }
                }).then(canvas => {
                    // 从文档中移除克隆元素
                    document.body.removeChild(clone);
                    
                    // 创建下载链接 - 修复iOS下载问题
                    if (navigator.userAgent.match(/iPhone|iPad|iPod/i)) {
                        // iOS设备使用特殊处理
                        const imgData = canvas.toDataURL('image/png');
                        const newTab = window.open();
                        newTab.document.write('<img src="' + imgData + '" />');
                        newTab.document.close();
                        
                        // 提示用户长按保存图片
                        setTimeout(() => {
                            alert('iOS用户请长按图片并选择"保存图像"来下载学生证');
                        }, 500);
                    } else {
                        // 其他设备使用常规下载方式
                        const link = document.createElement('a');
                        link.download = '慶桜大学学生証.png';
                        link.href = canvas.toDataURL('image/png');
                        document.body.appendChild(link);
                        link.click();
                        document.body.removeChild(link);
                    }
                    
                    // 隐藏加载指示器
                    loading.style.display = 'none';
                }).catch(error => {
                    console.error('Error generating image:', error);
                    alert('画像の生成中にエラーが発生しました。もう一度お試しください。');
                    loading.style.display = 'none';
                    document.body.removeChild(clone);
                });
            }, 100);
        }
        
        // 初始化
        updateStudentCard();
    </script>
</body>
</html>
