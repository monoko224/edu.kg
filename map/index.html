<!DOCTYPE html>
<html lang="ja">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>慶桜大学 - キャンパスマップ</title>
    <link href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@400;700&family=Noto+Serif+SC:wght@400;700&display=swap" rel="stylesheet">
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }
        
        body {
            font-family: 'Noto Serif JP', serif;
            background-color: #f8f9fa;
            color: #333;
            line-height: 1.6;
            transition: all 0.3s ease;
            overflow-x: hidden;
            touch-action: manipulation;
        }
        
        body.zh {
            font-family: 'Noto Serif SC', serif;
        }
        
        .container {
            max-width: 1200px;
            margin: 0 auto;
            padding: 20px;
        }
        
        header {
            background: linear-gradient(135deg, #a52a2a 0%, #7a1f1f 100%);
            color: white;
            padding: 15px 0;
            text-align: center;
            margin-bottom: 30px;
            box-shadow: 0 2px 10px rgba(0, 0, 0, 0.2);
            position: relative;
        }
        
        h1 {
            font-size: 2.2rem;
            margin-bottom: 10px;
            padding: 0 10px;
        }
        
        .language-switcher {
            margin: 15px 0;
            text-align: center;
        }
        
        .lang-btn {
            background: #d4af37;
            color: #333;
            border: none;
            padding: 8px 15px;
            margin: 0 5px;
            border-radius: 20px;
            cursor: pointer;
            font-weight: 500;
            transition: all 0.3s;
        }
        
        .lang-btn:hover {
            background: #b8941f;
            transform: translateY(-2px);
        }
        
        .lang-btn.active {
            background: #a52a2a;
            color: white;
        }
        
        .back-link {
            display: inline-block;
            margin-top: 20px;
            color: #a52a2a;
            text-decoration: none;
            font-weight: bold;
            padding: 10px 15px;
            border: 2px solid #a52a2a;
            border-radius: 5px;
            transition: all 0.3s;
            text-align: center;
        }
        
        .back-link:hover {
            background-color: #a52a2a;
            color: white;
        }
        
        /* 校园地图容器 */
        .campus-map-container {
            background: white;
            border-radius: 8px;
            padding: 15px;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.1);
            margin-bottom: 30px;
            overflow: hidden;
            position: relative;
            touch-action: none;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        .campus-map {
            position: relative;
            width: 1000px;
            height: 800px;
            background-color: #f0f8ff;
            border: 2px solid #a52a2a;
            transform-origin: 0 0;
            transition: transform 0.1s ease;
        }
        
        /* 道路样式 */
        .road {
            position: absolute;
            background-color: #d3d3d3;
            border: 1px solid #a0a0a0;
        }
        
        .road-horizontal {
            height: 20px;
        }
        
        .road-vertical {
            width: 20px;
        }
        
        /* 建筑通用样式 */
        .building {
            position: absolute;
            border: 2px solid #a52a2a;
            border-radius: 4px;
            padding: 8px;
            display: flex;
            align-items: center;
            justify-content: center;
            text-align: center;
            font-size: 14px;
            color: white;
            cursor: pointer;
            transition: all 0.3s ease;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
            z-index: 2;
        }
        
        .building:hover {
            transform: scale(1.05);
            z-index: 10;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.2);
        }
        
        /* 不同区域的背景色 */
        .academic {
            background-color: #a52a2a;
        }
        
        .research {
            background-color: #6a0dad;
        }
        
        .student {
            background-color: #d4af37;
            color: #333;
        }
        
        .recreation {
            background-color: #2e8b57;
        }
        
        .administration {
            background-color: #4682b4;
        }
        
        /* 绿化区域 */
        .green-area {
            position: absolute;
            background-color: #2e8b57;
            opacity: 0.3;
            border-radius: 8px;
            z-index: 1;
        }
        
        /* 图例样式 */
        .map-legend {
            display: flex;
            flex-wrap: wrap;
            gap: 15px;
            justify-content: center;
            margin-top: 20px;
            padding: 15px;
            background: white;
            border-radius: 8px;
            box-shadow: 0 3px 6px rgba(0, 0, 0, 0.1);
        }
        
        .legend-item {
            display: flex;
            align-items: center;
            margin-right: 15px;
        }
        
        .legend-color {
            width: 20px;
            height: 20px;
            margin-right: 8px;
            border: 1px solid #888;
            border-radius: 3px;
        }
        
        /* 建筑详情弹窗 */
        .building-modal {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background-color: rgba(0, 0, 0, 0.7);
            z-index: 100;
            justify-content: center;
            align-items: center;
        }
        
        .modal-content {
            background-color: white;
            padding: 30px;
            border-radius: 8px;
            max-width: 500px;
            width: 90%;
            box-shadow: 0 5px 15px rgba(0, 0, 0, 0.3);
            position: relative;
        }
        
        .close-modal {
            position: absolute;
            top: 10px;
            right: 15px;
            font-size: 24px;
            cursor: pointer;
            color: #888;
        }
        
        .close-modal:hover {
            color: #333;
        }
        
        /* 地图控制按钮 */
        .map-controls {
            display: flex;
            justify-content: center;
            margin: 15px 0;
            gap: 15px;
        }
        
        .map-btn {
            background: #a52a2a;
            color: white;
            border: none;
            padding: 10px 15px;
            border-radius: 5px;
            cursor: pointer;
            transition: all 0.3s;
        }
        
        .map-btn:hover {
            background: #7a1f1f;
        }
        
        /* 响应式设计 */
        @media (max-width: 1100px) {
            .campus-map {
                width: 800px;
                height: 700px;
            }
        }
        
        @media (max-width: 850px) {
            .campus-map {
                width: 600px;
                height: 600px;
            }
            
            .building {
                font-size: 12px;
                padding: 5px;
            }
        }
        
        @media (max-width: 768px) {
            .campus-map-container {
                padding: 10px;
                height: 70vh;
                overflow: hidden;
            }
            
            .campus-map {
                width: 1000px;
                height: 800px;
            }
            
            .road-horizontal {
                height: 15px;
            }
            
            .road-vertical {
                width: 15px;
            }
            
            .building {
                font-size: 11px;
                padding: 4px;
            }
            
            h1 {
                font-size: 1.8rem;
            }
            
            .map-legend {
                flex-direction: column;
                align-items: flex-start;
                gap: 10px;
            }
            
            .legend-item {
                margin-right: 0;
            }
            
            .map-controls {
                flex-wrap: wrap;
            }
        }
        
        @media (max-width: 480px) {
            h1 {
                font-size: 1.6rem;
            }
            
            .lang-btn {
                padding: 6px 12px;
                font-size: 14px;
                margin: 5px;
            }
            
            .building {
                font-size: 10px;
                padding: 3px;
            }
            
            .map-btn {
                padding: 8px 12px;
                font-size: 14px;
            }
        }
        
        /* 移动端触摸提示 */
        .touch-hint {
            display: none;
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.7);
            color: white;
            padding: 8px 15px;
            border-radius: 20px;
            font-size: 14px;
            z-index: 10;
        }
        
        @media (max-width: 768px) {
            .touch-hint {
                display: block;
            }
        }
    </style>
</head>
<body>
    <header>
        <h1 id="header-title">慶桜大学キャンパスマップ</h1>
        <p id="header-subtitle">エレガントなサボリとモーフィスの最高学府</p>
        
        <div class="language-switcher">
            <button class="lang-btn active" id="lang-ja">日本語</button>
            <button class="lang-btn" id="lang-zh">中文</button>
        </div>
    </header>
    
    <div class="container">
        <div class="map-controls">
            <button class="map-btn" id="zoom-in">
                <span class="ja-text">拡大</span>
                <span class="zh-text" style="display:none">放大</span>
            </button>
            <button class="map-btn" id="zoom-out">
                <span class="ja-text">縮小</span>
                <span class="zh-text" style="display:none">缩小</span>
            </button>
           
            <button class="map-btn" id="fit-map">
                <span class="ja-text">全体表示</span>
                <span class="zh-text" style="display:none">全图显示</span>
            </button>
        </div>
        
        <div class="campus-map-container" id="mapContainer">
            <div class="touch-hint" id="touchHint">
                <span class="ja-text">双指でズーム/移動できます</span>
                <span class="zh-text" style="display:none">使用双指缩放/移动</span>
            </div>
            <div class="campus-map" id="campusMap">
                <!-- 主干道 -->
                <div class="road road-horizontal" style="top: 200px; left: 0; width: 1000px;"></div>
                <div class="road road-horizontal" style="top: 600px; left: 0; width: 1000px;"></div>
                <div class="road road-vertical" style="top: 0; left: 300px; height: 800px;"></div>
                <div class="road road-vertical" style="top: 0; left: 700px; height: 800px;"></div>
                
                <!-- 绿化区域 -->
                <div class="green-area" style="top: 20px; left: 20px; width: 260px; height: 160px;"></div>
                <div class="green-area" style="top: 20px; left: 720px; width: 260px; height: 160px;"></div>
                <div class="green-area" style="top: 620px; left: 20px; width: 260px; height: 160px;"></div>
                <div class="green-area" style="top: 620px; left: 720px; width: 260px; height: 160px;"></div>
                <div class="green-area" style="top: 220px; left: 320px; width: 360px; height: 360px;"></div>
                
                <!-- 建筑物 -->
                <!-- 左上区域 - 教学区 -->
                <div class="building academic" style="top: 30px; left: 30px; width: 120px; height: 120px;" data-building="main-building">
                    <span class="ja-text">本部棟</span>
                    <span class="zh-text" style="display:none">主楼</span>
                </div>
                <div class="building academic" style="top: 30px; left: 170px; width: 100px; height: 120px;" data-building="classroom1">
                    <span class="ja-text">第1講義棟</span>
                    <span class="zh-text" style="display:none">第一教学楼</span>
                </div>
                
                <!-- 右上区域 - 研究设施 -->
                <div class="building research" style="top: 30px; left: 730px; width: 120px; height: 120px;" data-building="sleep-lab">
                    <span class="ja-text">居眠り研究室</span>
                    <span class="zh-text" style="display:none">瞌睡研究室</span>
                </div>
                <div class="building research" style="top: 30px; left: 870px; width: 100px; height: 120px;" data-building="phone-lab">
                    <span class="ja-text">スマホいじり施設</span>
                    <span class="zh-text" style="display:none">玩手机设施</span>
                </div>
                
                <!-- 中央区域 - 特色设施 -->
                <div class="building student" style="top: 240px; left: 340px; width: 140px; height: 140px;" data-building="elegant-saboli">
                    <span class="ja-text">エレガントサボリ<br>研究棟</span>
                    <span class="zh-text" style="display:none">优雅翘课<br>研究楼</span>
                </div>
                <div class="building research" style="top: 400px; left: 340px; width: 140px; height: 140px;" data-building="morphis-science">
                    <span class="ja-text">モーフィス科学<br>研究棟</span>
                    <span class="zh-text" style="display:none">摸鱼科学<br>研究楼</span>
                </div>
                <div class="building academic" style="top: 320px; left: 500px; width: 140px; height: 140px;" data-building="credit-acquisition">
                    <span class="ja-text">単位取得学<br>研究棟</span>
                    <span class="zh-text" style="display:none">学分取得学<br>研究楼</span>
                </div>
                
                <!-- 左下区域 - 学生设施 -->
                <div class="building student" style="top: 630px; left: 30px; width: 120px; height: 140px;" data-building="cafeteria">
                    <span class="ja-text">カフェテリア</span>
                    <span class="zh-text" style="display:none">餐厅</span>
                </div>
                <div class="building student" style="top: 630px; left: 170px; width: 100px; height: 140px;" data-building="student-center">
                    <span class="ja-text">学生センター</span>
                    <span class="zh-text" style="display:none">学生中心</span>
                </div>
                
                <!-- 右下区域 - 娱乐设施 -->
                <div class="building recreation" style="top: 630px; left: 730px; width: 120px; height: 140px;" data-building="game-center">
                    <span class="ja-text">ゲームセンター</span>
                    <span class="zh-text" style="display:none">游戏中心</span>
                </div>
                <div class="building recreation" style="top: 630px; left: 870px; width: 100px; height: 140px;" data-building="nap-room">
                    <span class="ja-text">仮眠室</span>
                    <span class="zh-text" style="display:none">休息室</span>
                </div>
                
                <!-- 中部区域 - 其他设施 -->
                <div class="building administration" style="top: 230px; left: 50px; width: 100px; height: 90px;" data-building="admin-office">
                    <span class="ja-text">事務局</span>
                    <span class="zh-text" style="display:none">行政办公室</span>
                </div>
                <div class="building student" style="top: 340px; left: 50px; width: 100px; height: 90px;" data-building="library">
                    <span class="ja-text">図書館</span>
                    <span class="zh-text" style="display:none">图书馆</span>
                </div>
                
                <div class="building administration" style="top: 230px; left: 850px; width: 100px; height: 90px;" data-building="president-office">
                    <span class="ja-text">学長室</span>
                    <span class="zh-text" style="display:none">校长办公室</span>
                </div>
                <div class="building student" style="top: 340px; left: 850px; width: 100px; height: 90px;" data-building="auditorium">
                    <span class="ja-text">大講堂</span>
                    <span class="zh-text" style="display:none">大礼堂</span>
                </div>
            </div>
        </div>
        
        <!-- 图例 -->
        <div class="map-legend">
            <div class="legend-item">
                <div class="legend-color" style="background-color: #a52a2a;"></div>
                <span class="ja-text">教学施設</span>
                <span class="zh-text" style="display:none">教学设施</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #6a0dad;"></div>
                <span class="ja-text">研究施設</span>
                <span class="zh-text" style="display:none">研究设施</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #d4af37;"></div>
                <span class="ja-text">学生施設</span>
                <span class="zh-text" style="display:none">学生设施</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #2e8b57;"></div>
                <span class="ja-text">レクリエーション</span>
                <span class="zh-text" style="display:none">娱乐设施</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #4682b4;"></div>
                <span class="ja-text">管理施設</span>
                <span class="zh-text" style="display:none">管理设施</span>
            </div>
            <div class="legend-item">
                <div class="legend-color" style="background-color: #2e8b57; opacity: 0.3;"></div>
                <span class="ja-text">緑地</span>
                <span class="zh-text" style="display:none">绿地</span>
            </div>
        </div>
        
        <a href="https://keio.edu.kg" class="back-link">
            <span class="ja-text">トップページに戻る</span>
            <span class="zh-text" style="display:none">返回首页</span>
        </a>
    </div>
    
    <!-- 建筑详情弹窗 -->
    <div class="building-modal" id="buildingModal">
        <div class="modal-content">
            <span class="close-modal">&times;</span>
            <h2 id="modalBuildingName">建物名</h2>
            <p id="modalBuildingDescription">建物の説明がここに入ります。</p>
        </div>
    </div>

    <script>
        // 当前语言状态
        let currentLanguage = 'ja';
        
        // 建筑信息数据 - 双语
        const buildingData = {
            'main-building': {
                name: { 'ja': '本部棟', 'zh': '主楼' },
                description: { 
                    'ja': '慶桜大学の中枢施設。学長室や主要な事務部門がここにあります。エレガントなデザインが特徴で、学生のサボリ技術を管理しています。',
                    'zh': '庆樱大学的中枢设施。校长办公室和主要行政部门设在这里。以优雅的设计为特点，管理学生的翘课技术。'
                }
            },
            'classroom1': {
                name: { 'ja': '第1講義棟', 'zh': '第一教学楼' },
                description: { 
                    'ja': '主要な講義が行われる教室棟。しかし慶桜大学では、ここで如何にして講義をサボるかも重要な学びの一つです。',
                    'zh': '主要课程的教学楼。但在庆樱大学，如何在这里翘课也是重要的学习内容之一。'
                }
            },
            'sleep-lab': {
                name: { 'ja': '居眠り研究室', 'zh': '瞌睡研究室' },
                description: { 
                    'ja': '日本有数の居眠り研究施設。教授にバレない完璧な居眠り姿勢を研究します。人体工学に基づいた最高の居眠り椅子を完備。',
                    'zh': '日本顶尖的瞌睡研究设施。研究不被教授发现的完美瞌睡姿势。配备符合人体工学的最佳瞌睡椅。'
                }
            },
            'phone-lab': {
                name: { 'ja': 'スマホいじり施設', 'zh': '玩手机设施' },
                description: { 
                    'ja': '授業中にスマホを最大限に活用する技術を磨く施設。教授の視界死角マップや瞬時に教科書画面に切り替える技術などを学べます。',
                    'zh': '磨练课堂上最大限度利用手机技术的设施。可学习教授视线死角地图、瞬间切换教科书画面的技术等。'
                }
            },
            'elegant-saboli': {
                name: { 'ja': 'エレガントサボリ研究棟', 'zh': '优雅翘课研究楼' },
                description: { 
                    'ja': '優雅に授業をサボるための総合的なスキルを研究する施設。教授に気づかれない完璧な欠席理由の創作技術から、友人による代返システムの構築まで。',
                    'zh': '研究优雅翘课综合技能的设施。从创作不被教授发现的完美缺勤理由，到构建朋友代答系统。'
                }
            },
            'morphis-science': {
                name: { 'ja': 'モーフィス科学研究棟', 'zh': '摸鱼科学研究楼' },
                description: { 
                    'ja': '長時間のスマホ操作、SNS巡回、堂々とした居眠りなど、授業中にバレずに時間を浪費する先進的技術を理論と実践の両面から研究します。',
                    'zh': '从理论和实践两方面研究长时间玩手机、刷SNS、坦然打瞌睡等课堂上不被发现浪费时间的高级技术。'
                }
            },
            'credit-acquisition': {
                name: { 'ja': '単位取得学研究棟', 'zh': '学分取得学研究楼' },
                description: { 
                    'ja': '最小の努力で最大の単位を取得する技術を追求。過去問分析技術、レポートコピペ検出回避法、一夜漬け記憶術など、優雅に卒業するための技能を修得します。',
                    'zh': '追求以最小努力获得最多学分的技术。学习往年试题分析技术、论文抄袭检测回避法、临阵磨枪记忆术等优雅毕业所需的技能。'
                }
            },
            'cafeteria': {
                name: { 'ja': 'カフェテリア', 'zh': '餐厅' },
                description: { 
                    'ja': '単位取得に疲れた学生のための癒し空間。無料のエナジードリンクと、教授の目を欺くための偽装勉強道具のレンタルサービスあり。',
                    'zh': '为学分取得而疲惫的学生的治愈空间。提供免费能量饮料和伪装学习用具租赁服务。'
                }
            },
            'student-center': {
                name: { 'ja': '学生センター', 'zh': '学生中心' },
                description: { 
                    'ja': '学生のための総合サポート施設。優雅なサボリ計画の立案支援や、単位取得の戦略相談など、慶桜大学生ならではのサービスを提供。',
                    'zh': '为学生提供综合支持的设施。提供优雅翘课计划制定支持、学分取得战略咨询等庆樱大学特有的服务。'
                }
            },
            'game-center': {
                name: { 'ja': 'ゲームセンター', 'zh': '游戏中心' },
                description: { 
                    'ja': '授業の合間にリフレッシュするための施設。ただし、ここで遊びすぎて単位を落とさないよう、適度なサボリを学ぶ場所でもあります。',
                    'zh': '课间休息放松的设施。但也是学习适度翘课的地方，以免在这里玩过头而挂科。'
                }
            },
            'nap-room': {
                name: { 'ja': '仮眠室', 'zh': '休息室' },
                description: { 
                    'ja': '居眠りの実践的な訓練を行う施設。様々なシチュエーションでの居眠り技術を磨き、教授の目を欺く技術を高めます。',
                    'zh': '进行瞌睡实践训练的设施。磨练各种情境下的瞌睡技术，提高欺骗教授双眼的技术。'
                }
            },
            'admin-office': {
                name: { 'ja': '事務局', 'zh': '行政办公室' },
                description: { 
                    'ja': '学生の出席管理や単位認定を行う事務部門。しかし慶桜大学の事務局職員は、いかに学生のサボリを見逃すかも重要な仕事の一つです。',
                    'zh': '管理学生出勤和学分认定的行政部门。但庆樱大学的行政办公室职员，如何对学生的翘课视而不见也是重要工作之一。'
                }
            },
            'library': {
                name: { 'ja': '図書館', 'zh': '图书馆' },
                description: { 
                    'ja': '勉強するふりをしながら実際にはサボる技術を學ぶ施設。見かけは真面目な学生でも、内心はどうサボるかを考えているのが慶桜流。',
                    'zh': '学习假装学习实则翘课技术的设施。外表是认真学生，内心却在思考如何翘课，这就是庆樱风格。'
                }
            },
            'president-office': {
                name: { 'ja': '学長室', 'zh': '校长办公室' },
                description: { 
                    'ja': 'Tom 湯学長のオフィス。「最小の努力で最大の成果を挙げる」という慶桜大学の理念を体現した空間です。',
                    'zh': 'Tom 湯校长的办公室。体现了"以最小努力获取最大成果"的庆樱大学理念的空间。'
                }
            },
            'auditorium': {
                name: { 'ja': '大講堂', 'zh': '大礼堂' },
                description: { 
                    'ja': '大学全体の集会や式典を行う施設。ただし慶桜大学の式典は短く効率的で、如何にして早く終わらせるかも研究課題の一つです。',
                    'zh': '举行大学集会和典礼的设施。但庆樱大学的典礼简短高效，如何尽快结束也是研究课题之一。'
                }
            }
        };

        // 地图缩放和平移变量
        let scale = 1;
        let posX = 0;
        let posY = 0;
        let isDragging = false;
        let startX, startY;
        let initialTouches = [];
        let lastZoomDistance = 0;

        // 获取DOM元素
        const mapElement = document.getElementById('campusMap');
        const mapContainer = document.getElementById('mapContainer');
        
        // 初始化地图
        function initMap() {
            const containerWidth = mapContainer.clientWidth;
            const containerHeight = mapContainer.clientHeight;
            
            // 计算适合容器的缩放比例
            const scaleX = containerWidth / 1000;
            const scaleY = containerHeight / 800;
            
            // 选择较小的缩放比例以确保地图完全可见
            scale = Math.min(scaleX, scaleY) * 0.95; // 稍微缩小一点以便看到边框
            
            // 居中显示
            posX = (containerWidth - 1000 * scale) / 2;
            posY = (containerHeight - 800 * scale) / 2;
            
            updateMapTransform();
        }
        
        // 更新地图变换
        function updateMapTransform() {
            mapElement.style.transform = `translate(${posX}px, ${posY}px) scale(${scale})`;
        }
        
        // 鼠标事件处理
        mapContainer.addEventListener('mousedown', (e) => {
            if (e.button !== 0) return; // 只处理左键
            isDragging = true;
            startX = e.clientX - posX;
            startY = e.clientY - posY;
            mapContainer.style.cursor = 'grabbing';
        });
        
        document.addEventListener('mousemove', (e) => {
            if (!isDragging) return;
            posX = e.clientX - startX;
            posY = e.clientY - startY;
            updateMapTransform();
        });
        
        document.addEventListener('mouseup', () => {
            isDragging = false;
            mapContainer.style.cursor = 'grab';
        });
        
        // 触摸事件处理
        let touchStartTime = 0;
        let touchStartX = 0;
        let touchStartY = 0;
        
        mapContainer.addEventListener('touchstart', (e) => {
            if (e.touches.length === 1) {
                // 单指拖动
                isDragging = true;
                startX = e.touches[0].clientX - posX;
                startY = e.touches[0].clientY - posY;
                
                // 记录触摸开始时间和位置，用于判断是否是点击
                touchStartTime = Date.now();
                touchStartX = e.touches[0].clientX;
                touchStartY = e.touches[0].clientY;
            } else if (e.touches.length === 2) {
                // 双指缩放
                isDragging = false;
                initialTouches = [e.touches[0], e.touches[1]];
                lastZoomDistance = Math.hypot(
                    initialTouches[0].clientX - initialTouches[1].clientX,
                    initialTouches[0].clientY - initialTouches[1].clientY
                );
            }
            e.preventDefault();
        });
        
        mapContainer.addEventListener('touchmove', (e) => {
            if (isDragging && e.touches.length === 1) {
                // 单指拖动
                posX = e.touches[0].clientX - startX;
                posY = e.touches[0].clientY - startY;
                updateMapTransform();
            } else if (e.touches.length === 2) {
                // 双指缩放
                const touch1 = e.touches[0];
                const touch2 = e.touches[1];
                
                // 计算当前两指距离
                const currentDistance = Math.hypot(
                    touch1.clientX - touch2.clientX,
                    touch1.clientY - touch2.clientY
                );
                
                if (lastZoomDistance !== 0) {
                    // 计算缩放比例
                    const zoomFactor = currentDistance / lastZoomDistance;
                    
                    // 计算缩放中心点
                    const centerX = (touch1.clientX + touch2.clientX) / 2;
                    const centerY = (touch1.clientY + touch2.clientY) / 2;
                    
                    // 应用缩放
                    const newScale = scale * zoomFactor;
                    
                    // 限制缩放范围
                    if (newScale >= 0.2 && newScale <= 3) {
                        // 计算缩放后的位置偏移，使缩放中心保持不动
                        const containerRect = mapContainer.getBoundingClientRect();
                        const relativeX = centerX - containerRect.left;
                        const relativeY = centerY - containerRect.top;
                        
                        const mapX = (relativeX - posX) / scale;
                        const mapY = (relativeY - posY) / scale;
                        
                        scale = newScale;
                        
                        posX = relativeX - mapX * scale;
                        posY = relativeY - mapY * scale;
                        
                        updateMapTransform();
                    }
                }
                
                lastZoomDistance = currentDistance;
            }
            e.preventDefault();
        });
        
        mapContainer.addEventListener('touchend', (e) => {
            // 检查是否是点击事件
            if (e.touches.length === 0 && isDragging) {
                const touch = e.changedTouches[0];
                const touchTime = Date.now();
                const touchDuration = touchTime - touchStartTime;
                const deltaX = touch.clientX - touchStartX;
                const deltaY = touch.clientY - touchStartY;
                const distance = Math.sqrt(deltaX * deltaX + deltaY * deltaY);
                
                // 如果是短距离点击（不是拖动）
                if (touchDuration < 300 && distance < 10) {
                    // 获取点击的元素
                    const element = document.elementFromPoint(touch.clientX, touch.clientY);
                    if (element && element.closest('.building')) {
                        const building = element.closest('.building');
                        const buildingId = building.getAttribute('data-building');
                        showBuildingInfo(buildingId);
                    }
                }
            }
            
            if (e.touches.length === 0) {
                isDragging = false;
                initialTouches = [];
                lastZoomDistance = 0;
            } else if (e.touches.length === 1) {
                // 从双指缩放切换到单指拖动
                isDragging = true;
                startX = e.touches[0].clientX - posX;
                startY = e.touches[0].clientY - posY;
                initialTouches = [];
                lastZoomDistance = 0;
            }
        });
        
        // 鼠标滚轮事件处理 - 根据设备类型区别处理
        if (!('ontouchstart' in window)) {
            // PC端：禁止滚轮缩放
            mapContainer.addEventListener('wheel', (e) => {
                e.preventDefault(); // 阻止默认滚动行为但不进行缩放
            });
        } else {
            // 移动端：保留原有的滚轮缩放逻辑
            mapContainer.addEventListener('wheel', (e) => {
                e.preventDefault();
                
                // 计算缩放因子
                const zoomIntensity = 0.1;
                const wheel = e.deltaY < 0 ? 1 : -1;
                const zoomFactor = Math.exp(wheel * zoomIntensity);
                const newScale = scale * zoomFactor;
                
                // 限制缩放范围
                if (newScale < 0.2 || newScale > 3) return;
                
                // 计算缩放中心点
                const rect = mapContainer.getBoundingClientRect();
                const mouseX = e.clientX - rect.left;
                const mouseY = e.clientY - rect.top;
                
                // 计算鼠标在地图上的位置
                const mapX = (mouseX - posX) / scale;
                const mapY = (mouseY - posY) / scale;
                
                // 更新缩放和位置
                scale = newScale;
                posX = mouseX - mapX * scale;
                posY = mouseY - mapY * scale;
                
                updateMapTransform();
            });
        }
        
        // 控制按钮功能
        document.getElementById('zoom-in').addEventListener('click', () => {
            scale = Math.min(scale * 1.2, 3);
            updateMapTransform();
        });
        
        document.getElementById('zoom-out').addEventListener('click', () => {
            scale = Math.max(scale * 0.8, 0.2);
            updateMapTransform();
        });
        
       
        
        document.getElementById('fit-map').addEventListener('click', () => {
            initMap();
        });
        
        // 切换语言函数
        function changeLanguage(lang) {
            currentLanguage = lang;
            
            // 更新按钮状态
            document.getElementById('lang-ja').classList.toggle('active', lang === 'ja');
            document.getElementById('lang-zh').classList.toggle('active', lang === 'zh');
            
            // 更新页面文本
            document.querySelectorAll('.ja-text, .zh-text').forEach(element => {
                if (element.classList.contains('ja-text')) {
                    element.style.display = lang === 'ja' ? 'inline' : 'none';
                } else if (element.classList.contains('zh-text')) {
                    element.style.display = lang === 'zh' ? 'inline' : 'none';
                }
            });
            
            // 更新body字体
            if (lang === 'ja') {
                document.body.classList.remove('zh');
            } else {
                document.body.classList.add('zh');
            }
            
            // 更新弹窗内容（如果打开着）
            const modal = document.getElementById('buildingModal');
            if (modal.style.display === 'flex') {
                const buildingId = modal.getAttribute('data-current-building');
                if (buildingId) {
                    const data = buildingData[buildingId];
                    if (data) {
                        document.getElementById('modalBuildingName').textContent = data.name[lang];
                        document.getElementById('modalBuildingDescription').textContent = data.description[lang];
                    }
                }
            }
        }
        
        // 弹窗功能
        const modal = document.getElementById('buildingModal');
        const closeBtn = document.querySelector('.close-modal');
        const buildingName = document.getElementById('modalBuildingName');
        const buildingDescription = document.getElementById('modalBuildingDescription');
        
        // 点击建筑显示详情
        function showBuildingInfo(buildingId) {
            const data = buildingData[buildingId];
            
            if (data) {
                buildingName.textContent = data.name[currentLanguage];
                buildingDescription.textContent = data.description[currentLanguage];
                modal.setAttribute('data-current-building', buildingId);
                modal.style.display = 'flex';
            }
        }
        
        // 为建筑添加点击事件
        document.querySelectorAll('.building').forEach(building => {
            building.addEventListener('click', () => {
                const buildingId = building.getAttribute('data-building');
                showBuildingInfo(buildingId);
            });
        });
        
        // 关闭弹窗
        closeBtn.addEventListener('click', () => {
            modal.style.display = 'none';
        });
        
        // 点击弹窗外部关闭
        window.addEventListener('click', (event) => {
            if (event.target === modal) {
                modal.style.display = 'none';
            }
        });
        
        // 语言切换事件
        document.getElementById('lang-ja').addEventListener('click', () => {
            changeLanguage('ja');
        });
        
        document.getElementById('lang-zh').addEventListener('click', () => {
            changeLanguage('zh');
        });
        
        // 页面加载时初始化
        window.addEventListener('load', () => {
            // 设置默认语言
            changeLanguage('ja');
            
            // 初始化地图
            initMap();
            
            // 隐藏触摸提示 after 5 seconds
            setTimeout(() => {
                document.getElementById('touchHint').style.opacity = '0';
                setTimeout(() => {
                    document.getElementById('touchHint').style.display = 'none';
                }, 1000);
            }, 5000);
        });
        
        // 窗口大小变化时重新初始化地图
        window.addEventListener('resize', initMap);
    </script>
</body>
</html>
